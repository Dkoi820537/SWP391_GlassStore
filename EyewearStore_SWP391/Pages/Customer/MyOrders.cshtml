@page
@model EyewearStore_SWP391.Pages.Customer.MyOrdersModel
@{
    ViewData["Title"] = "My Orders";
}

<div class="container py-5">
    <!-- ===== PAGE HEADER ===== -->
    <div class="mb-5">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a asp-page="/Index">Home</a></li>
                <li class="breadcrumb-item active">My Orders</li>
            </ol>
        </nav>

        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
            <div>
                <h1 style="font-family: var(--font-secondary);
                           color: var(--primary-navy);
                           font-size: 2.5rem;
                           margin-bottom: 0.5rem;">
                    🛍️ My Orders
                    @if (Model.Orders.Any())
                    {
                        <span class="badge" style="background: var(--primary-gold);
                                                            font-size: 1.2rem;
                                                            vertical-align: middle;">
                            @Model.Orders.Count
                        </span>
                    }
                </h1>
                <p style="color: var(--secondary-warm-gray); font-size: 1.1rem; margin: 0;">
                    Track your orders and manage returns
                </p>
            </div>

            @if (Model.Orders.Any())
            {
                <a asp-page="/Index"
                   class="btn btn-primary"
                   style="padding: 0.875rem 2rem;
                                  background: linear-gradient(135deg, var(--primary-navy) 0%, var(--primary-navy-light) 100%);
                                  border: none;
                                  border-radius: 8px;
                                  font-weight: 600;">
                    <i class="bi bi-shop me-2"></i>Continue Shopping
                </a>
            }
        </div>
    </div>

    @if (!Model.Orders.Any())
    {
        <!-- ===== EMPTY STATE ===== -->
        <div class="card" style="border: none;
                                          border-radius: 16px;
                                          box-shadow: var(--shadow-lg);
                                          text-align: center;
                                          padding: 5rem 3rem;
                                          background: linear-gradient(135deg, var(--white) 0%, var(--secondary-cream) 100%);">
            <div style="font-size: 6rem; opacity: 0.2; margin-bottom: 2rem;">🛒</div>
            <h2 style="color: var(--primary-navy); margin-bottom: 1rem; font-family: var(--font-secondary);">
                No Orders Yet
            </h2>
            <p style="color: var(--secondary-warm-gray); font-size: 1.1rem; margin-bottom: 2.5rem;">
                You haven't placed any orders yet. Start shopping for premium eyewear!
            </p>
            <a asp-page="/Index"
               class="btn btn-primary btn-lg"
               style="padding: 1.25rem 3rem;
                              background: linear-gradient(135deg, var(--primary-navy) 0%, var(--primary-navy-light) 100%);
                              border: none;
                              border-radius: 10px;">
                <i class="bi bi-shop me-2"></i>Shop Now
            </a>
        </div>
    }
    else
    {
        <!-- ===== ORDERS LIST ===== -->
        <div class="row g-4">
            @foreach (var order in Model.Orders)
            {
                // compute helpers directly (KHÔNG dùng @{ } ở đây)
                var canReturn = (order.Status == "Delivered" || order.Status == "Completed")
                && (DateTime.UtcNow - order.CreatedAt).TotalDays <= 30;
                var daysLeft = 30 - (int)(DateTime.UtcNow - order.CreatedAt).TotalDays;

                <div class="col-12">
                    <div class="card order-card"
                         style="border: none;
                                                border-radius: 16px;
                                                box-shadow: var(--shadow-md);
                                                overflow: hidden;
                                                transition: all 0.3s ease;">

                        <!-- Card Header -->
                        <div style="background: linear-gradient(135deg, var(--primary-navy) 0%, var(--primary-navy-light) 100%);
                                                    padding: 1.5rem 2rem;">
                            <div class="row align-items-center">
                                <div class="col-md-7">
                                    <h4 style="color: white; margin: 0 0 0.5rem 0; font-weight: 600;">
                                        <i class="bi bi-receipt-cutoff me-2"></i>
                                        Order #@order.OrderId
                                    </h4>
                                    <div style="color: rgba(255,255,255,0.9); font-size: 0.95rem;">
                                        <i class="bi bi-calendar3 me-1"></i>
                                        @order.CreatedAt.ToString("MMMM dd, yyyy 'at' HH:mm")
                                    </div>
                                </div>
                                <div class="col-md-5 text-md-end mt-3 mt-md-0">
                                    <span class="badge @(Model.GetStatusBadgeClass(order.Status))"
                                          style="font-size: 1rem; padding: 0.5rem 1.25rem; border-radius: 20px;">
                                        <i class="@(Model.GetStatusIcon(order.Status)) me-1"></i>
                                        @order.Status
                                    </span>

                                    @if (canReturn && daysLeft > 0)
                                    {
                                        <div class="mt-2">
                                            <small style="color: rgba(255,255,255,0.8); font-size: 0.85rem;">
                                                <i class="bi bi-clock-history me-1"></i>
                                                @daysLeft days left to return
                                            </small>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>

                        <!-- Card Body -->
                        <div class="card-body" style="padding: 2rem;">

                            <!-- Progress Bar -->
                            @if (order.Status != "Cancelled")
                            {
                                <div class="mb-4">
                                    <div class="d-flex justify-content-between mb-2">
                                        <small style="font-weight: 600; color: var(--primary-navy);">Order Progress</small>
                                        <small style="font-weight: 600; color: var(--primary-gold);">
                                            @(Model.GetStatusProgress(order.Status))%
                                        </small>
                                    </div>
                                    <div class="progress" style="height: 10px; border-radius: 10px; background: var(--light-gray);">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated"
                                             style="width: @(Model.GetStatusProgress(order.Status))%;
                                                                background: linear-gradient(90deg, var(--primary-gold) 0%, var(--primary-gold-light) 100%);
                                                                border-radius: 10px;">
                                        </div>
                                    </div>
                                </div>
                            }

                            <!-- ✅ PRESCRIPTION INDICATOR -->
                            @if (order.HasPrescription)
                            {
                                <div class="alert"
                                     style="background: linear-gradient(135deg, rgba(156, 39, 176, 0.08) 0%, rgba(186, 104, 200, 0.05) 100%);
                                                                    border: none;
                                                                    border-left: 4px solid #9c27b0;
                                                                    border-radius: 10px;
                                                                    padding: 1rem 1.25rem;
                                                                    margin-bottom: 1.5rem;">
                                    <div class="d-flex align-items-center">
                                        <div style="font-size: 2rem; margin-right: 1rem; color: #9c27b0;">👓</div>
                                        <div>
                                            <strong style="color: #9c27b0; font-size: 1.05rem;">Prescription Order</strong>
                                            <p class="mb-0" style="color: #7b1fa2; font-size: 0.9rem; margin-top: 0.25rem;">
                                                This order includes custom prescription lenses.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            }

                            <!-- Order Info Grid -->
                            <div class="row g-4 mb-4">
                                <div class="col-md-4">
                                    <div class="info-box" style="background: var(--light-gray);
                                                                                  padding: 1.25rem;
                                                                                  border-radius: 12px;
                                                                                  height: 100%;">
                                        <div class="d-flex align-items-start">
                                            <i class="bi bi-geo-alt-fill"
                                               style="color: var(--primary-gold);
                                                                      font-size: 1.5rem;
                                                                      margin-right: 0.75rem;"></i>
                                            <div>
                                                <small style="color: var(--secondary-warm-gray);
                                                                              font-size: 0.85rem;
                                                                              text-transform: uppercase;
                                                                              letter-spacing: 0.5px;">
                                                    Shipping To
                                                </small>
                                                <div style="color: var(--primary-navy); font-weight: 600; margin-top: 0.25rem;">
                                                    @order.ReceiverName
                                                </div>
                                                <div style="color: var(--dark-gray); font-size: 0.9rem;">
                                                    @order.Phone
                                                </div>
                                                <div style="color: var(--dark-gray); font-size: 0.9rem;">
                                                    @order.AddressLine
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-4">
                                    <div class="info-box" style="background: var(--light-gray);
                                                                                  padding: 1.25rem;
                                                                                  border-radius: 12px;
                                                                                  height: 100%;">
                                        <div class="d-flex align-items-start">
                                            <i class="bi bi-credit-card-fill"
                                               style="color: var(--success);
                                                                      font-size: 1.5rem;
                                                                      margin-right: 0.75rem;"></i>
                                            <div>
                                                <small style="color: var(--secondary-warm-gray);
                                                                              font-size: 0.85rem;
                                                                              text-transform: uppercase;
                                                                              letter-spacing: 0.5px;">
                                                    Payment
                                                </small>
                                                <div style="color: var(--primary-navy); font-weight: 600; margin-top: 0.25rem;">
                                                    @order.PaymentMethod
                                                </div>
                                                @if (!string.IsNullOrEmpty(order.TrackingNumber))
                                                {
                                                    <div style="margin-top: 0.5rem;">
                                                        <small style="color: var(--secondary-warm-gray);">Tracking:</small>
                                                        <code style="background: white;
                                                                                             padding: 0.25rem 0.5rem;
                                                                                             border-radius: 4px;
                                                                                             font-size: 0.85rem;">
                                                            @order.TrackingNumber
                                                        </code>
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-4">
                                    <div class="info-box" style="background: var(--light-gray);
                                                                                  padding: 1.25rem;
                                                                                  border-radius: 12px;
                                                                                  height: 100%;">
                                        <div class="d-flex align-items-start">
                                            <i class="bi bi-box-seam-fill"
                                               style="color: var(--secondary-teal);
                                                                      font-size: 1.5rem;
                                                                      margin-right: 0.75rem;"></i>
                                            <div>
                                                <small style="color: var(--secondary-warm-gray);
                                                                              font-size: 0.85rem;
                                                                              text-transform: uppercase;
                                                                              letter-spacing: 0.5px;">
                                                    Order Total
                                                </small>
                                                <div style="color: var(--primary-gold);
                                                                           font-weight: 700;
                                                                           font-size: 1.5rem;
                                                                           font-family: var(--font-secondary);
                                                                           margin-top: 0.25rem;">
                                                    @order.TotalAmount.ToString("N0") VND
                                                </div>
                                                <div style="color: var(--dark-gray); font-size: 0.9rem;">
                                                    @order.ItemCount item(s)
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Products List -->
                            <div class="products-section mb-4">
                                <h6 style="color: var(--primary-navy);
                                                          font-weight: 600;
                                                          border-bottom: 2px solid var(--medium-gray);
                                                          padding-bottom: 0.75rem;
                                                          margin-bottom: 1.25rem;">
                                    <i class="bi bi-bag-check me-2"></i>Products in Order
                                </h6>

                                @foreach (var product in order.Products)
                                {
                                    <div class="product-item"
                                         style="background: white;
                                                                        border: 2px solid var(--medium-gray);
                                                                        border-radius: 12px;
                                                                        padding: 1.25rem;
                                                                        margin-bottom: 1rem;">
                                        <div class="row align-items-center">
                                            <div class="col-md-7">
                                                <h6 style="color: var(--primary-navy); font-weight: 600; margin-bottom: 0.5rem;">
                                                    @product.Name
                                                </h6>
                                                <div style="color: var(--secondary-warm-gray); font-size: 0.9rem;">
                                                    <span class="badge" style="background: var(--light-gray); color: var(--dark-gray);">
                                                        SKU: @product.Sku
                                                    </span>
                                                    <span class="ms-2">Qty: <strong>×@product.Quantity</strong></span>
                                                </div>
                                            </div>
                                            <div class="col-md-5 text-md-end">
                                                <div style="color: var(--primary-navy); font-weight: 700; font-size: 1.25rem;">
                                                    @product.UnitPrice.ToString("N0") VND
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>

                            <!-- ✅ ACTION BUTTONS WITH REQUEST RETURN -->
                            <div class="d-flex gap-2 flex-wrap justify-content-end mt-4">
                                @if (canReturn)
                                {
                                    <a asp-page="/Customer/RequestReturn"
                                       asp-route-orderId="@order.OrderId"
                                       class="btn btn-warning"
                                       style="padding: 0.75rem 1.5rem;
                                                          border-radius: 8px;
                                                          font-weight: 600;
                                                          background: linear-gradient(135deg, #ff9800 0%, #ffb74d 100%);
                                                          border: none;
                                                          color: white;
                                                          box-shadow: 0 2px 8px rgba(255, 152, 0, 0.3);">
                                        <i class="bi bi-arrow-repeat me-1"></i>Request Return
                                    </a>
                                }

                                @if (order.Status == "Pending")
                                {
                                    <button class="btn btn-outline-danger"
                                            style="padding: 0.75rem 1.5rem;
                                                                       border-radius: 8px;
                                                                       font-weight: 600;">
                                        <i class="bi bi-x-circle me-1"></i>Cancel Order
                                    </button>
                                }

                                <button class="btn btn-primary"
                                        data-bs-toggle="modal"
                                        data-bs-target="#modal@(order.OrderId)"
                                        style="padding: 0.75rem 2rem;
                                                               background: linear-gradient(135deg, var(--primary-gold) 0%, var(--primary-gold-light) 100%);
                                                               border: none;
                                                               border-radius: 8px;
                                                               font-weight: 600;">
                                    <i class="bi bi-eye me-1"></i>View Details
                                </button>
                            </div>

                            @if (canReturn && daysLeft <= 7)
                            {
                                <div class="alert alert-warning mt-3" style="border-radius: 8px; border-left: 4px solid #ff9800;">
                                    <i class="bi bi-exclamation-triangle me-2"></i>
                                    <strong>Hurry!</strong> You have only <strong>@daysLeft days</strong> left to request a return for this order.
                                </div>
                            }
                            else if ((DateTime.UtcNow - order.CreatedAt).TotalDays > 30 && (order.Status == "Delivered" || order.Status == "Completed"))
                            {
                                <div class="alert alert-secondary mt-3" style="border-radius: 8px;">
                                    <i class="bi bi-info-circle me-2"></i>
                                    The 30-day return window for this order has expired.
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <!-- Modal (keep or add your modal code here) -->
            }
        </div>
    }
</div>

<style>
    .breadcrumb {
        background: transparent;
        padding: 0;
    }

    .breadcrumb-item + .breadcrumb-item::before {
        content: "›";
        color: var(--secondary-warm-gray);
    }

    .breadcrumb-item a {
        color: var(--primary-gold);
        text-decoration: none;
    }

    .order-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 24px rgba(0,0,0,0.15) !important;
    }

    .btn-warning:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(255, 152, 0, 0.4) !important;
    }

    .info-box {
        transition: all 0.3s ease;
    }

        .info-box:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
</style>