@page "{orderId:int}"
@model EyewearStore_SWP391.Pages.Customer.RequestReturnModel
@{
    ViewData["Title"] = "Request Return";
}

<div class="container py-5">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a asp-page="/Index">Home</a></li>
            <li class="breadcrumb-item"><a asp-page="/Customer/MyOrders">My Orders</a></li>
            <li class="breadcrumb-item active">Request Return</li>
        </ol>
    </nav>

    <!-- Page Header -->
    <div class="mb-5">
        <h1 style="font-family: var(--font-secondary);
                   color: var(--primary-navy);
                   font-size: 2.5rem;
                   margin-bottom: 0.5rem;">
            🔄 Request Return/Exchange
        </h1>
        <p style="color: var(--secondary-warm-gray); font-size: 1.1rem;">
            Order #@Model.Order?.OrderId - We're here to help!
        </p>
    </div>

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong>⚠️</strong> @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <form method="post" enctype="multipart/form-data">
        <div class="row g-4">
            <!-- Left Column: Form -->
            <div class="col-lg-8">

                <!-- Step 1: Select Products -->
                <div class="card mb-4" style="border: none; border-radius: 16px; box-shadow: var(--shadow-md); overflow: hidden;">
                    <div style="background: linear-gradient(135deg, var(--primary-navy) 0%, var(--primary-navy-light) 100%);
                                padding: 1.5rem 2rem;">
                        <h4 style="color: white; margin: 0; font-weight: 600;">
                            <span class="badge bg-white text-primary me-2" style="font-size: 1rem;">1</span>
                            Select Items to Return
                        </h4>
                    </div>
                    <div class="card-body" style="padding: 2rem;">
                        @if (Model.Order?.OrderItems != null && Model.Order.OrderItems.Any())
                        {
                            <div class="row g-3">
                                @foreach (var item in Model.Order.OrderItems)
                                {
                                    <div class="col-12">
                                        <div class="product-select-card"
                                             style="border: 2px solid var(--medium-gray);
                                                            border-radius: 12px;
                                                            padding: 1.5rem;
                                                            transition: all 0.3s ease;
                                                            cursor: pointer;"
                                             onclick="toggleProductSelection(@item.OrderItemId)">

                                            <div class="d-flex align-items-start gap-3">
                                                <!-- Checkbox -->
                                                <div class="form-check" style="padding: 0;">
                                                    <input class="form-check-input product-checkbox"
                                                           type="checkbox"
                                                           name="SelectedOrderItemIds"
                                                           value="@item.OrderItemId"
                                                           id="item_@item.OrderItemId"
                                                           style="width: 1.5rem;
                                                                          height: 1.5rem;
                                                                          cursor: pointer;
                                                                          border: 2px solid var(--primary-navy);"
                                                           onchange="updateSelection(this)">
                                                </div>

                                                <!-- Product Image -->
                                                <div style="width: 80px;
                                                                   height: 80px;
                                                                   background: var(--light-gray);
                                                                   border-radius: 10px;
                                                                   display: flex;
                                                                   align-items: center;
                                                                   justify-content: center;
                                                                   flex-shrink: 0;">
                                                    <i class="bi bi-eyeglasses" style="font-size: 2rem; color: var(--primary-gold);"></i>
                                                </div>

                                                <!-- Product Info -->
                                                <div class="flex-grow-1">
                                                    <h6 style="color: var(--primary-navy);
                                                                      font-weight: 600;
                                                                      margin-bottom: 0.5rem;">
                                                        @item.Product?.Name
                                                    </h6>
                                                    <div style="color: var(--secondary-warm-gray); font-size: 0.9rem;">
                                                        <span class="badge" style="background: var(--light-gray); color: var(--dark-gray);">
                                                            SKU: @item.Product?.Sku
                                                        </span>
                                                        <span class="ms-2">Qty: <strong>@item.Quantity</strong></span>
                                                    </div>
                                                    <div style="color: var(--primary-gold);
                                                                       font-weight: 700;
                                                                       font-size: 1.1rem;
                                                                       margin-top: 0.5rem;">
                                                        @item.UnitPrice.ToString("N0") VND
                                                    </div>

                                                    <!-- Quantity Selector (shown when selected) -->
                                                    <div class="quantity-selector mt-2"
                                                         id="qty_@item.OrderItemId"
                                                         style="display: none;">
                                                        <label style="font-size: 0.85rem;
                                                                             color: var(--dark-gray);
                                                                             font-weight: 600;">
                                                            Return Quantity:
                                                        </label>
                                                        <select name="ReturnQuantities_@item.OrderItemId"
                                                                class="form-select form-select-sm mt-1"
                                                                style="width: 100px; border-radius: 6px;">
                                                            @for (int i = 1; i <= item.Quantity; i++)
                                                            {
                                                                <option value="@i" selected="@(i == item.Quantity)">@i</option>
                                                            }
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="text-center py-5" style="color: var(--secondary-warm-gray);">
                                <i class="bi bi-inbox" style="font-size: 3rem; opacity: 0.3;"></i>
                                <p class="mt-3">No items available for return</p>
                            </div>
                        }
                    </div>
                </div>

                <!-- Step 2: Return Details -->
                <div class="card mb-4" style="border: none; border-radius: 16px; box-shadow: var(--shadow-md); overflow: hidden;">
                    <div style="background: linear-gradient(135deg, #9c27b0 0%, #ba68c8 100%);
                                padding: 1.5rem 2rem;">
                        <h4 style="color: white; margin: 0; font-weight: 600;">
                            <span class="badge bg-white me-2" style="color: #9c27b0; font-size: 1rem;">2</span>
                            Return Details
                        </h4>
                    </div>
                    <div class="card-body" style="padding: 2rem;">

                        <!-- Return Type -->
                        <div class="mb-4">
                            <label class="form-label" style="font-weight: 600; color: var(--primary-navy); font-size: 1rem;">
                                <i class="bi bi-arrow-repeat me-2"></i>What would you like to do?
                            </label>
                            <div class="return-type-options">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <input type="radio"
                                               class="btn-check"
                                               name="ReturnType"
                                               id="refund"
                                               value="Refund"
                                               checked>
                                        <label class="btn btn-outline-primary w-100"
                                               for="refund"
                                               style="padding: 1rem;
                                                      border-radius: 10px;
                                                      border: 2px solid var(--medium-gray);
                                                      transition: all 0.3s ease;">
                                            <i class="bi bi-cash-coin d-block" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                                            <strong>Refund</strong>
                                            <div style="font-size: 0.85rem; opacity: 0.8;">Get money back</div>
                                        </label>
                                    </div>
                                    <div class="col-md-4">
                                        <input type="radio"
                                               class="btn-check"
                                               name="ReturnType"
                                               id="exchange"
                                               value="Exchange">
                                        <label class="btn btn-outline-primary w-100"
                                               for="exchange"
                                               style="padding: 1rem;
                                                      border-radius: 10px;
                                                      border: 2px solid var(--medium-gray);
                                                      transition: all 0.3s ease;">
                                            <i class="bi bi-arrow-left-right d-block" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                                            <strong>Exchange</strong>
                                            <div style="font-size: 0.85rem; opacity: 0.8;">Get replacement</div>
                                        </label>
                                    </div>
                                    <div class="col-md-4">
                                        <input type="radio"
                                               class="btn-check"
                                               name="ReturnType"
                                               id="repair"
                                               value="Repair">
                                        <label class="btn btn-outline-primary w-100"
                                               for="repair"
                                               style="padding: 1rem;
                                                      border-radius: 10px;
                                                      border: 2px solid var(--medium-gray);
                                                      transition: all 0.3s ease;">
                                            <i class="bi bi-tools d-block" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                                            <strong>Repair</strong>
                                            <div style="font-size: 0.85rem; opacity: 0.8;">Fix the issue</div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Reason Category -->
                        <div class="mb-4">
                            <label class="form-label" style="font-weight: 600; color: var(--primary-navy); font-size: 1rem;">
                                <i class="bi bi-list-check me-2"></i>Why are you returning this?
                            </label>
                            <select name="ReasonCategory"
                                    class="form-select"
                                    required
                                    style="border: 2px solid var(--medium-gray);
                                           border-radius: 10px;
                                           padding: 0.875rem 1rem;
                                           font-size: 1rem;">
                                <option value="">Select a reason...</option>
                                <option value="Defective">🔧 Defective/Damaged Product</option>
                                <option value="Wrong Item">📦 Wrong Item Received</option>
                                <option value="Not As Described">📝 Not As Described</option>
                                <option value="Quality Issue">⭐ Quality Issue</option>
                                <option value="Size Issue">📏 Size/Fit Issue</option>
                                <option value="Changed Mind">💭 Changed My Mind</option>
                                <option value="Other">📋 Other Reason</option>
                            </select>
                        </div>

                        <!-- Detailed Description -->
                        <div class="mb-4">
                            <label class="form-label" style="font-weight: 600; color: var(--primary-navy); font-size: 1rem;">
                                <i class="bi bi-chat-left-text me-2"></i>Tell us more (Optional)
                            </label>
                            <textarea name="Description"
                                      class="form-control"
                                      rows="4"
                                      placeholder="Please describe the issue in detail. This helps us process your request faster..."
                                      style="border: 2px solid var(--medium-gray);
                                             border-radius: 10px;
                                             padding: 1rem;
                                             font-size: 0.95rem;
                                             resize: vertical;"></textarea>
                        </div>

                        <!-- Upload Images -->
                        <div class="mb-4">
                            <label class="form-label" style="font-weight: 600; color: var(--primary-navy); font-size: 1rem;">
                                <i class="bi bi-camera me-2"></i>Upload Photos (Optional but recommended)
                            </label>
                            <div class="upload-area"
                                 id="uploadArea"
                                 style="border: 3px dashed var(--medium-gray);
                                        border-radius: 12px;
                                        padding: 3rem 2rem;
                                        text-align: center;
                                        background: var(--light-gray);
                                        transition: all 0.3s ease;
                                        cursor: pointer;">
                                <i class="bi bi-cloud-upload" style="font-size: 3rem; color: var(--primary-gold);"></i>
                                <p style="margin: 1rem 0 0.5rem; color: var(--primary-navy); font-weight: 600;">
                                    Click to upload or drag and drop
                                </p>
                                <p style="color: var(--secondary-warm-gray); font-size: 0.9rem; margin: 0;">
                                    PNG, JPG up to 5MB (Max 5 photos)
                                </p>
                                <input type="file"
                                       id="imageInput"
                                       name="Images"
                                       multiple
                                       accept="image/*"
                                       style="display: none;">
                            </div>
                            <div id="imagePreview" class="mt-3"></div>
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="text-end">
                    <a asp-page="/Customer/MyOrders"
                       class="btn btn-outline-secondary btn-lg me-2"
                       style="padding: 1rem 2rem; border-radius: 10px;">
                        <i class="bi bi-x-circle me-2"></i>Cancel
                    </a>
                    <button type="submit"
                            class="btn btn-primary btn-lg"
                            style="padding: 1rem 3rem;
                                   background: linear-gradient(135deg, var(--primary-gold) 0%, var(--primary-gold-light) 100%);
                                   border: none;
                                   border-radius: 10px;
                                   font-weight: 600;">
                        <i class="bi bi-send me-2"></i>Submit Return Request
                    </button>
                </div>
            </div>

            <!-- Right Column: Policy & Summary -->
            <div class="col-lg-4">
                <!-- Return Policy -->
                <div class="card mb-4" style="border: none; border-radius: 16px; box-shadow: var(--shadow-md); position: sticky; top: 100px;">
                    <div style="background: linear-gradient(135deg, var(--secondary-teal) 0%, #4a7c7e 100%);
                                padding: 1.5rem;">
                        <h5 style="color: white; margin: 0; font-weight: 600;">
                            <i class="bi bi-shield-check me-2"></i>Return Policy
                        </h5>
                    </div>
                    <div class="card-body" style="padding: 1.5rem;">
                        <ul style="list-style: none; padding: 0; margin: 0;">
                            <li style="padding: 0.75rem 0; border-bottom: 1px solid var(--light-gray);">
                                <i class="bi bi-check-circle-fill me-2" style="color: var(--success);"></i>
                                <strong>30-day</strong> return window
                            </li>
                            <li style="padding: 0.75rem 0; border-bottom: 1px solid var(--light-gray);">
                                <i class="bi bi-check-circle-fill me-2" style="color: var(--success);"></i>
                                <strong>Free return</strong> shipping
                            </li>
                            <li style="padding: 0.75rem 0; border-bottom: 1px solid var(--light-gray);">
                                <i class="bi bi-check-circle-fill me-2" style="color: var(--success);"></i>
                                <strong>Full refund</strong> on approval
                            </li>
                            <li style="padding: 0.75rem 0; border-bottom: 1px solid var(--light-gray);">
                                <i class="bi bi-check-circle-fill me-2" style="color: var(--success);"></i>
                                <strong>24-48 hours</strong> review time
                            </li>
                            <li style="padding: 0.75rem 0;">
                                <i class="bi bi-check-circle-fill me-2" style="color: var(--success);"></i>
                                <strong>7-10 days</strong> refund processing
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- Help Card -->
                <div class="card" style="border: none; border-radius: 16px; background: linear-gradient(135deg, var(--secondary-cream) 0%, var(--light-gray) 100%); padding: 1.5rem;">
                    <h6 style="color: var(--primary-navy); font-weight: 600; margin-bottom: 1rem;">
                        <i class="bi bi-question-circle me-2"></i>Need Help?
                    </h6>
                    <p style="color: var(--dark-gray); font-size: 0.9rem; margin-bottom: 1rem;">
                        Our customer support team is here to assist you!
                    </p>
                    <a asp-page="/Contact"
                       class="btn btn-primary w-100"
                       style="background: var(--primary-navy);
                              border: none;
                              padding: 0.75rem;
                              border-radius: 8px;">
                        <i class="bi bi-headset me-2"></i>Contact Support
                    </a>
                </div>
            </div>
        </div>
    </form>
</div>

<style>
    .breadcrumb {
        background: transparent;
        padding: 0;
    }

    .breadcrumb-item + .breadcrumb-item::before {
        content: "›";
    }

    .breadcrumb-item a {
        color: var(--primary-gold);
        text-decoration: none;
    }

    .product-select-card:hover {
        border-color: var(--primary-gold) !important;
        box-shadow: 0 4px 12px rgba(212, 165, 116, 0.2);
    }

    .product-checkbox:checked ~ * {
        opacity: 1;
    }

    .btn-check:checked + .btn-outline-primary {
        background: linear-gradient(135deg, var(--primary-navy) 0%, var(--primary-navy-light) 100%);
        border-color: var(--primary-navy);
        color: white;
    }

    .upload-area:hover {
        border-color: var(--primary-gold);
        background: rgba(212, 165, 116, 0.05);
    }

    .image-preview-item {
        position: relative;
        display: inline-block;
        margin: 0.5rem;
    }

        .image-preview-item img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid var(--medium-gray);
        }

        .image-preview-item .remove-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--error);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
</style>

<script>
    function toggleProductSelection(itemId) {
        const checkbox = document.getElementById('item_' + itemId);
        checkbox.checked = !checkbox.checked;
        updateSelection(checkbox);
    }

    function updateSelection(checkbox) {
        const itemId = checkbox.value;
        const qtySelector = document.getElementById('qty_' + itemId);
        const card = checkbox.closest('.product-select-card');

        if (checkbox.checked) {
            qtySelector.style.display = 'block';
            card.style.borderColor = 'var(--primary-gold)';
            card.style.background = 'rgba(212, 165, 116, 0.05)';
        } else {
            qtySelector.style.display = 'none';
            card.style.borderColor = 'var(--medium-gray)';
            card.style.background = 'white';
        }
    }

    // Image upload handling
    const uploadArea = document.getElementById('uploadArea');
    const imageInput = document.getElementById('imageInput');
    const imagePreview = document.getElementById('imagePreview');

    uploadArea.addEventListener('click', () => imageInput.click());

    imageInput.addEventListener('change', function(e) {
        handleFiles(this.files);
    });

    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = 'var(--primary-gold)';
    });

    uploadArea.addEventListener('dragleave', () => {
        uploadArea.style.borderColor = 'var(--medium-gray)';
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = 'var(--medium-gray)';
        handleFiles(e.dataTransfer.files);
    });

    function handleFiles(files) {
        imagePreview.innerHTML = '';
        Array.from(files).slice(0, 5).forEach((file, index) => {
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const div = document.createElement('div');
                    div.className = 'image-preview-item';
                    div.innerHTML = `
                        <img src="${e.target.result}" alt="Preview ${index + 1}">
                        <button type="button" class="remove-btn" onclick="this.parentElement.remove()">×</button>
                    `;
                    imagePreview.appendChild(div);
                };
                reader.readAsDataURL(file);
            }
        });
    }
</script>
