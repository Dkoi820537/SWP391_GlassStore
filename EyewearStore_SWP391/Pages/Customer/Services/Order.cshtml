@page
@model EyewearStore_SWP391.Pages.Customer.Services.OrderModel
@{
    ViewData["Title"] = "Eyewear Services";
    Layout = "_Layout";
}

<style>
    .os-wrap {
        max-width: 1100px;
        margin: 0 auto;
        padding: 40px 20px 80px;
    }

    /* ── STEPS ── */
    .steps {
        display: flex;
        align-items: center;
        gap: 0;
        margin-bottom: 40px;
        overflow-x: auto;
        padding-bottom: 4px;
    }

    .step {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        flex: 1;
        min-width: 90px;
        cursor: pointer;
        opacity: .45;
        transition: opacity .2s;
    }

        .step.active {
            opacity: 1;
        }

        .step.done {
            opacity: .7;
        }

    .step-circle {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: #e8eaf2;
        border: 2px solid #c8cadc;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        transition: all .2s;
    }

    .step.active .step-circle {
        background: #5b5bdb;
        border-color: #5b5bdb;
        color: #fff;
        box-shadow: 0 4px 14px rgba(91,91,219,.35);
    }

    .step.done .step-circle {
        background: #0e9f6e;
        border-color: #0e9f6e;
        color: #fff;
    }

    .step-label {
        font-size: 11px;
        font-weight: 700;
        color: #8b8da8;
        text-align: center;
        text-transform: uppercase;
        letter-spacing: .8px;
    }

    .step.active .step-label {
        color: #5b5bdb;
    }

    .step.done .step-label {
        color: #0e9f6e;
    }

    .step-line {
        flex: 1;
        height: 2px;
        background: #e8eaf2;
        min-width: 24px;
        margin-bottom: 24px;
    }

        .step-line.done {
            background: #0e9f6e;
        }

    /* ── PANEL ── */
    .os-panel {
        display: none;
    }

        .os-panel.active {
            display: block;
        }

        .os-panel h2 {
            font-size: 1.4rem;
            font-weight: 800;
            color: #12132a;
            margin: 0 0 6px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .os-panel p {
            font-size: 13px;
            color: #8b8da8;
            margin: 0 0 22px;
        }

    /* ── PRODUCT GRID ── */
    .prod-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 14px;
        margin-bottom: 24px;
    }

    .prod-card {
        border: 2px solid #e8eaf2;
        border-radius: 14px;
        padding: 16px;
        cursor: pointer;
        transition: all .2s;
        background: #fff;
        text-align: center;
        position: relative;
    }

        .prod-card:hover {
            border-color: #5b5bdb;
            box-shadow: 0 4px 16px rgba(91,91,219,.12);
        }

        .prod-card.selected {
            border-color: #5b5bdb;
            background: rgba(91,91,219,.05);
            box-shadow: 0 4px 16px rgba(91,91,219,.18);
        }

            .prod-card.selected::after {
                content: '✓';
                position: absolute;
                top: 8px;
                right: 10px;
                width: 22px;
                height: 22px;
                background: #5b5bdb;
                color: #fff;
                border-radius: 50%;
                font-size: 12px;
                font-weight: 700;
                display: flex;
                align-items: center;
                justify-content: center;
                line-height: 22px;
            }

    .prod-img {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 10px;
        margin: 0 auto 10px;
        display: block;
        background: #f0f2f8;
    }

    .prod-img-ph {
        width: 80px;
        height: 80px;
        border-radius: 10px;
        margin: 0 auto 10px;
        background: #f0f2f8;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 30px;
    }

    .prod-name {
        font-size: 13px;
        font-weight: 700;
        color: #12132a;
        margin-bottom: 4px;
    }

    .prod-price {
        font-size: 13px;
        font-weight: 600;
        color: #b06c00;
    }

    /* ── SERVICE GRID ── */
    .svc-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 14px;
        margin-bottom: 24px;
    }

    .svc-card {
        border: 2px solid #e8eaf2;
        border-radius: 14px;
        padding: 18px 16px;
        cursor: pointer;
        transition: all .2s;
        background: #fff;
        position: relative;
    }

        .svc-card:hover {
            border-color: #5b5bdb;
        }

        .svc-card.selected {
            border-color: #5b5bdb;
            background: rgba(91,91,219,.05);
            box-shadow: 0 4px 16px rgba(91,91,219,.18);
        }

            .svc-card.selected::after {
                content: '✓';
                position: absolute;
                top: 10px;
                right: 12px;
                width: 22px;
                height: 22px;
                background: #5b5bdb;
                color: #fff;
                border-radius: 50%;
                font-size: 12px;
                font-weight: 700;
                line-height: 22px;
                text-align: center;
            }

    .svc-name {
        font-size: 14px;
        font-weight: 700;
        color: #12132a;
        margin-bottom: 4px;
    }

    .svc-desc {
        font-size: 12px;
        color: #8b8da8;
        margin-bottom: 8px;
        line-height: 1.4;
    }

    .svc-price {
        font-size: 14px;
        font-weight: 700;
        color: #b06c00;
    }

    .svc-dur {
        font-size: 11px;
        color: #8b8da8;
        margin-top: 2px;
    }

    /* ── SUMMARY ── */
    .summary-box {
        background: #f0f2f8;
        border-radius: 14px;
        padding: 20px 22px;
        margin-bottom: 20px;
    }

    .sum-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #e0e2ee;
        font-size: 14px;
    }

        .sum-row:last-child {
            border-bottom: none;
        }

        .sum-row.total {
            font-size: 17px;
            font-weight: 800;
            color: #12132a;
        }

    .sum-lbl {
        color: #8b8da8;
        font-weight: 500;
    }

    .sum-val {
        color: #12132a;
        font-weight: 600;
    }

    .sum-price {
        color: #b06c00;
        font-weight: 700;
        font-family: 'DM Mono', monospace;
    }

    .sum-item {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .sum-thumb {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        object-fit: cover;
        background: #e8eaf2;
        border: 1px solid #d0d2e4;
        flex-shrink: 0;
    }

    .sum-thumb-ph {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        background: #e8eaf2;
        border: 1px solid #d0d2e4;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        flex-shrink: 0;
    }

    /* ── BUTTONS ── */
    .btn-next {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: linear-gradient(135deg, #5b5bdb, #4747c2);
        color: #fff;
        border: none;
        border-radius: 10px;
        padding: 12px 28px;
        font-size: 14px;
        font-weight: 700;
        cursor: pointer;
        transition: all .2s;
        box-shadow: 0 4px 14px rgba(91,91,219,.3);
    }

        .btn-next:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 22px rgba(91,91,219,.35);
        }

        .btn-next:disabled {
            opacity: .4;
            cursor: not-allowed;
            transform: none;
        }

    .btn-back {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: #f0f2f8;
        color: #8b8da8;
        border: 1px solid #e0e2ee;
        border-radius: 10px;
        padding: 12px 20px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all .2s;
    }

        .btn-back:hover {
            background: #e8eaf2;
            color: #40415e;
        }

    .btn-add {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: linear-gradient(135deg, #0e9f6e, #07875d);
        color: #fff;
        border: none;
        border-radius: 10px;
        padding: 13px 32px;
        font-size: 15px;
        font-weight: 700;
        cursor: pointer;
        transition: all .2s;
        box-shadow: 0 4px 14px rgba(14,159,110,.3);
    }

        .btn-add:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 22px rgba(14,159,110,.35);
        }

    .nav-btns {
        display: flex;
        gap: 12px;
        align-items: center;
        margin-top: 8px;
    }

    .empty-state {
        text-align: center;
        padding: 40px;
        color: #8b8da8;
        background: #f8f9fc;
        border-radius: 14px;
        border: 2px dashed #e0e2ee;
    }

        .empty-state .ei {
            font-size: 40px;
            opacity: .3;
            margin-bottom: 10px;
            display: block;
        }
</style>

<div class="os-wrap">
    <!-- Page heading -->
    <div style="margin-bottom: 32px;">
        <h1 style="font-size: 2rem; font-weight: 800; color: #12132a; margin: 0 0 6px; display: flex; align-items: center; gap: 12px;">
            🔧 Eyewear Services
        </h1>
        <p style="font-size: 14px; color: #8b8da8; margin: 0;">
            Pick your frame, choose a lens, select a fitting service — we'll do the rest.
        </p>
    </div>

    <!-- STEPS INDICATOR -->
    <div class="steps" id="stepsBar">
        <div class="step active" id="step1Ind" onclick="goStep(1)">
            <div class="step-circle">🕶</div>
            <div class="step-label">Frame</div>
        </div>
        <div class="step-line" id="line12"></div>
        <div class="step active" id="step2Ind" onclick="goStep(2)">
            <div class="step-circle">⭕</div>
            <div class="step-label">Lens</div>
        </div>
        <div class="step-line" id="line23"></div>
        <div class="step" id="step3Ind" onclick="goStep(3)">
            <div class="step-circle">⚙️</div>
            <div class="step-label">Service</div>
        </div>
        <div class="step-line" id="line34"></div>
        <div class="step" id="step4Ind">
            <div class="step-circle">✅</div>
            <div class="step-label">Confirm</div>
        </div>
    </div>

    <!-- ── STEP 1: FRAME ── -->
    <div class="os-panel active" id="panel1">
        <h2>🕶 Choose a Frame</h2>
        <p>Select the eyeglass frame you want fitted</p>

        @if (Model.Frames.Any())
        {
            <div class="prod-grid" id="frameGrid">
                @foreach (var f in Model.Frames)
                {
                    var img = f.ProductImages?.OrderByDescending(x => x.IsPrimary).FirstOrDefault()?.ImageUrl;
                    <div class="prod-card" data-id="@f.ProductId" data-name="@f.Name"
                         data-price="@f.Price" data-img="@(img ?? "")"
                         onclick="selectFrame(this)">
                        @if (!string.IsNullOrEmpty(img))
                        {
                            <img src="@img" class="prod-img" alt="@f.Name" />
                        }
                        else
                        {
                            <div class="prod-img-ph">🕶</div>
                        }
                        <div class="prod-name">@f.Name</div>
                        <div class="prod-price">@f.Price.ToString("N0") ₫</div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="empty-state">
                <span class="ei">🕶</span>
                <p>No frames available at the moment.</p>
            </div>
        }

        <div class="nav-btns">
            <button class="btn-next" id="btnNext1" onclick="goStep(2)" disabled>
                Next: Choose Lens <i class="bi bi-arrow-right"></i>
            </button>
        </div>
    </div>

    <!-- ── STEP 2: LENS ── -->
    <div class="os-panel" id="panel2">
        <h2>⭕ Choose a Lens</h2>
        <p>Select the lens to be fitted into your frame</p>

        @if (Model.Lenses.Any())
        {
            <div class="prod-grid" id="lensGrid">
                @foreach (var l in Model.Lenses)
                {
                    var img = l.ProductImages?.OrderByDescending(x => x.IsPrimary).FirstOrDefault()?.ImageUrl;
                    <div class="prod-card" data-id="@l.ProductId" data-name="@l.Name"
                         data-price="@l.Price" data-img="@(img ?? "")"
                         onclick="selectLens(this)">
                        @if (!string.IsNullOrEmpty(img))
                        {
                            <img src="@img" class="prod-img" alt="@l.Name" />
                        }
                        else
                        {
                            <div class="prod-img-ph">⭕</div>
                        }
                        <div class="prod-name">@l.Name</div>
                        <div class="prod-price">@l.Price.ToString("N0") ₫</div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="empty-state">
                <span class="ei">⭕</span>
                <p>No lenses available at the moment.</p>
            </div>
        }

        <div class="nav-btns">
            <button class="btn-back" onclick="goStep(1)">
                <i class="bi bi-arrow-left"></i> Back
            </button>
            <button class="btn-next" id="btnNext2" onclick="goStep(3)" disabled>
                Next: Choose Service <i class="bi bi-arrow-right"></i>
            </button>
        </div>
    </div>

    <!-- ── STEP 3: SERVICE ── -->
    <div class="os-panel" id="panel3">
        <h2>⚙️ Choose a Fitting Service</h2>
        <p>Select the type of workmanship for your order</p>

        @if (Model.Services.Any())
        {
            <div class="svc-grid" id="serviceGrid">
                @foreach (var s in Model.Services)
                {
                    <div class="svc-card" data-id="@s.ServiceId" data-name="@s.Name"
                         data-price="@s.Price"
                         data-dur="@(s.DurationMin.HasValue? s.DurationMin + " min" : "")"
                         onclick="selectService(this)">
                        <div class="svc-name">@s.Name</div>
                        @if (!string.IsNullOrEmpty(s.Description))
                        {
                            <div class="svc-desc">@s.Description</div>
                        }
                        <div class="svc-price">@s.Price.ToString("N0") ₫</div>
                        @if (s.DurationMin.HasValue)
                        {
                            <div class="svc-dur"><i class="bi bi-clock" style="font-size:10px"></i> @s.DurationMin min</div>
                        }
                    </div>
                }
            </div>
        }
        else
        {
            <div class="empty-state">
                <span class="ei">⚙️</span>
                <p>No services available at the moment.</p>
            </div>
        }

        <div class="nav-btns">
            <button class="btn-back" onclick="goStep(2)">
                <i class="bi bi-arrow-left"></i> Back
            </button>
            <button class="btn-next" id="btnNext3" onclick="goStep(4)" disabled>
                Review Order <i class="bi bi-arrow-right"></i>
            </button>
        </div>
    </div>

    <!-- ── STEP 4: CONFIRM ── -->
    <div class="os-panel" id="panel4">
        <h2>✅ Review Your Order</h2>
        <p>Double-check everything before adding to cart</p>

        <div class="summary-box" id="summaryBox">
            <!-- populated by JS -->
        </div>

        <form method="post" asp-page="/Cart/Add" id="addForm">
            <input type="hidden" name="ProductId" id="fFrameId" />
            <input type="hidden" name="LensProductId" id="fLensId" />
            <input type="hidden" name="ServiceId" id="fServiceId" />
            <input type="hidden" name="Quantity" value="1" />

            <div class="nav-btns">
                <button type="button" class="btn-back" onclick="goStep(3)">
                    <i class="bi bi-arrow-left"></i> Back
                </button>
                <button type="submit" class="btn-add">
                    <i class="bi bi-cart-plus"></i> Add to Cart
                </button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        /* ── STATE ── */
        let sel = { frame: null, lens: null, service: null };

        /* ── STEP NAV ── */
        function goStep(n) {
            // Validate before advancing
            if (n > 1 && !sel.frame)   { alert('Please select a frame first.');   return; }
            if (n > 2 && !sel.lens)    { alert('Please select a lens first.');     return; }
            if (n > 3 && !sel.service) { alert('Please select a service first.');  return; }

            [1,2,3,4].forEach(i => {
                document.getElementById('panel' + i).classList.toggle('active', i === n);
            });

            updateStepBar(n);
            if (n === 4) buildSummary();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function updateStepBar(current) {
            [1,2,3,4].forEach(i => {
                const el = document.getElementById('step' + i + 'Ind');
                if (!el) return;
                el.classList.remove('active', 'done');
                if (i < current)      el.classList.add('done');
                else if (i === current) el.classList.add('active');
            });
            // Lines
            [['line12',2],['line23',3],['line34',4]].forEach(([id, thresh]) => {
                const el = document.getElementById(id);
                if (el) el.classList.toggle('done', current >= thresh);
            });
        }

        /* ── SELECT FRAME ── */
        function selectFrame(card) {
            document.querySelectorAll('#frameGrid .prod-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            sel.frame = {
                id:    card.dataset.id,
                name:  card.dataset.name,
                price: parseFloat(card.dataset.price),
                img:   card.dataset.img
            };
            document.getElementById('btnNext1').disabled = false;
        }

        /* ── SELECT LENS ── */
        function selectLens(card) {
            document.querySelectorAll('#lensGrid .prod-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            sel.lens = {
                id:    card.dataset.id,
                name:  card.dataset.name,
                price: parseFloat(card.dataset.price),
                img:   card.dataset.img
            };
            document.getElementById('btnNext2').disabled = false;
        }

        /* ── SELECT SERVICE ── */
        function selectService(card) {
            document.querySelectorAll('#serviceGrid .svc-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            sel.service = {
                id:    card.dataset.id,
                name:  card.dataset.name,
                price: parseFloat(card.dataset.price),
                dur:   card.dataset.dur
            };
            document.getElementById('btnNext3').disabled = false;
        }

        /* ── BUILD SUMMARY ── */
        function buildSummary() {
            const f = sel.frame, l = sel.lens, s = sel.service;
            const total = f.price + l.price + s.price;

            const fmtImg = (img, emoji) => img
                ? `<img src="${img}" class="sum-thumb" />`
                : `<div class="sum-thumb-ph">${emoji}</div>`;

            document.getElementById('summaryBox').innerHTML = `
                <div class="sum-row">
                    <div class="sum-item">
                        ${fmtImg(f.img, '🕶')}
                        <div>
                            <div style="font-size:12px;color:#8b8da8;font-weight:600;text-transform:uppercase;letter-spacing:.8px">Frame</div>
                            <div style="font-size:14px;font-weight:700;color:#12132a">${f.name}</div>
                        </div>
                    </div>
                    <div class="sum-price">${f.price.toLocaleString('vi-VN')} ₫</div>
                </div>
                <div class="sum-row">
                    <div class="sum-item">
                        ${fmtImg(l.img, '⭕')}
                        <div>
                            <div style="font-size:12px;color:#8b8da8;font-weight:600;text-transform:uppercase;letter-spacing:.8px">Lens</div>
                            <div style="font-size:14px;font-weight:700;color:#12132a">${l.name}</div>
                        </div>
                    </div>
                    <div class="sum-price">${l.price.toLocaleString('vi-VN')} ₫</div>
                </div>
                <div class="sum-row">
                    <div class="sum-item">
                        <div class="sum-thumb-ph">⚙️</div>
                        <div>
                            <div style="font-size:12px;color:#8b8da8;font-weight:600;text-transform:uppercase;letter-spacing:.8px">Service</div>
                            <div style="font-size:14px;font-weight:700;color:#12132a">${s.name}${s.dur ? ' <span style="font-size:11px;color:#8b8da8;font-weight:500">· ' + s.dur + '</span>' : ''}</div>
                        </div>
                    </div>
                    <div class="sum-price">${s.price.toLocaleString('vi-VN')} ₫</div>
                </div>
                <div class="sum-row total">
                    <span>Total</span>
                    <span class="sum-price" style="font-size:18px">${total.toLocaleString('vi-VN')} ₫</span>
                </div>`;

            // Populate hidden form fields
            document.getElementById('fFrameId').value   = f.id;
            document.getElementById('fLensId').value     = l.id;
            document.getElementById('fServiceId').value  = s.id;
        }

        // Init step bar
        updateStepBar(1);
    </script>
}
