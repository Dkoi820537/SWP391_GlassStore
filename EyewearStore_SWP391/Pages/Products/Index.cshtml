@page
@model EyewearStore_SWP391.Pages.Products.IndexModel
@{
    ViewData["Title"] = "Shop Eyewear - Browse Frames & Lenses";
    Layout = "_Layout";
}

@section Styles {
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="~/css/shop.css" asp-append-version="true" />
    <style>
        /* ‚îÄ‚îÄ Wishlist Heart Button ‚îÄ‚îÄ */
        .product-image {
            position: relative;
        }

        .btn-wishlist {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 36px;
            height: 36px;
            background: rgba(255, 255, 255, 0.92);
            border: 1px solid rgba(0,0,0,0.08);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 15px;
            color: #aaa;
            backdrop-filter: blur(6px);
            transition: color .2s, background .2s, transform .25s, border-color .2s;
            z-index: 5;
            box-shadow: 0 2px 8px rgba(0,0,0,0.10);
        }

            .btn-wishlist:hover {
                color: #e05a6a;
                background: #fff;
                border-color: #f5c0c7;
                transform: scale(1.12);
            }

            .btn-wishlist.active,
            .btn-wishlist[data-in-wishlist="true"] {
                color: #c9a96e;
                background: #fffbf5;
                border-color: #e8d5b0;
            }

            .btn-wishlist.pop {
                animation: heart-pop .28s cubic-bezier(0.34, 1.56, 0.64, 1);
            }

        @@keyframes heart-pop {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.4);
            }

            100% {
                transform: scale(1);
            }
        }

        /* ‚îÄ‚îÄ Wishlist Toast ‚îÄ‚îÄ */
        #wl-toast {
            position: fixed;
            bottom: 28px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #0f0f0f;
            color: #fff;
            border-radius: 12px;
            padding: 12px 22px;
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 8px 28px rgba(0,0,0,0.22);
            z-index: 9999;
            white-space: nowrap;
            transition: transform .35s cubic-bezier(0.34,1.56,0.64,1);
            pointer-events: none;
        }

            #wl-toast.show {
                transform: translateX(-50%) translateY(0);
            }

            #wl-toast .wl-icon {
                font-size: 16px;
            }
    </style>
}

<div class="shop-container">
    <!-- Breadcrumb Navigation -->
    <nav class="shop-breadcrumb" aria-label="Breadcrumb">
        <ol>
            <li><a asp-page="/Index"><i class="bi bi-house-door"></i> Home</a></li>
            <li class="separator"><i class="bi bi-chevron-right"></i></li>
            <li class="current" aria-current="page">Shop</li>
        </ol>
    </nav>

    <!-- Page Header -->
    <header class="shop-header">
        <h1>Browse Our Collection</h1>
        <p class="shop-subtitle">Discover premium eyewear crafted for style and comfort</p>
    </header>

    <!-- Main Content -->
    <div class="shop-content">
        <!-- Filter Sidebar -->
        <aside class="filter-sidebar" id="filterSidebar">
            <div class="filter-header">
                <h3><i class="bi bi-funnel"></i> Filters</h3>
                <a asp-page="/Products/Index" class="clear-filters-link" id="clearFilters">
                    <i class="bi bi-x-circle"></i> Clear All
                </a>
            </div>

            <form method="get" asp-page="/Products/Index" id="filterForm">
                <!-- Product Type Pills -->
                <div class="filter-section">
                    <h4>Product Type</h4>
                    <div class="product-type-pills">
                        <button type="submit"
                                name="ProductTypeFilter"
                                value="All"
                                class="type-pill @(Model.ProductTypeFilter == "All" ? "active" : "")">
                            All
                        </button>
                        <button type="submit"
                                name="ProductTypeFilter"
                                value="Frame"
                                class="type-pill @(Model.ProductTypeFilter == "Frame" ? "active" : "")">
                            <i class="bi bi-eyeglasses"></i> Frames
                        </button>
                        <button type="submit"
                                name="ProductTypeFilter"
                                value="Lens"
                                class="type-pill @(Model.ProductTypeFilter == "Lens" ? "active" : "")">
                            <i class="bi bi-circle"></i> Lenses
                        </button>
                    </div>
                    <input type="hidden" name="SearchTerm" value="@Model.SearchTerm" />
                    <input type="hidden" name="MinPrice" value="@Model.MinPrice" />
                    <input type="hidden" name="MaxPrice" value="@Model.MaxPrice" />
                    <input type="hidden" name="FrameMaterialFilter" value="@Model.FrameMaterialFilter" />
                    <input type="hidden" name="FrameTypeFilter" value="@Model.FrameTypeFilter" />
                    <input type="hidden" name="LensTypeFilter" value="@Model.LensTypeFilter" />
                    <input type="hidden" name="SortBy" value="@Model.SortBy" />
                </div>
            </form>

            <form method="get" asp-page="/Products/Index" id="searchFilterForm">
                <input type="hidden" name="ProductTypeFilter" value="@Model.ProductTypeFilter" />

                <div class="filter-section">
                    <h4>Search</h4>
                    <div class="search-input-wrapper">
                        <i class="bi bi-search search-icon"></i>
                        <input type="text"
                               name="SearchTerm"
                               value="@Model.SearchTerm"
                               placeholder="Search products..."
                               class="search-input"
                               id="searchInput" />
                    </div>
                </div>

                <div class="filter-section">
                    <h4>Price Range</h4>
                    <div class="price-range-inputs">
                        <div class="price-input-group">
                            <label for="minPrice">Min</label>
                            <input type="number" name="MinPrice" value="@Model.MinPrice"
                                   placeholder="0" min="0" step="0.01" class="price-input" id="minPrice" />
                        </div>
                        <span class="price-separator">‚Äî</span>
                        <div class="price-input-group">
                            <label for="maxPrice">Max</label>
                            <input type="number" name="MaxPrice" value="@Model.MaxPrice"
                                   placeholder="Any" min="0" step="0.01" class="price-input" id="maxPrice" />
                        </div>
                    </div>
                </div>

                @if (Model.ProductTypeFilter == "All" || Model.ProductTypeFilter == "Frame")
                {
                    <div class="filter-section frame-filters">
                        <h4><i class="bi bi-eyeglasses"></i> Frame Options</h4>
                        @if (Model.Catalog.AvailableFrameMaterials.Any())
                        {
                            <div class="select-wrapper">
                                <label for="frameMaterialFilter">Material</label>
                                <select name="FrameMaterialFilter" id="frameMaterialFilter" class="filter-select">
                                    <option value="">All Materials</option>
                                    @foreach (var material in Model.Catalog.AvailableFrameMaterials)
                                    {
                                        <option value="@material" selected="@(Model.FrameMaterialFilter == material)">@material</option>
                                    }
                                </select>
                                <i class="bi bi-chevron-down select-arrow"></i>
                            </div>
                        }
                        @if (Model.Catalog.AvailableFrameTypes.Any())
                        {
                            <div class="select-wrapper">
                                <label for="frameTypeFilter">Frame Type</label>
                                <select name="FrameTypeFilter" id="frameTypeFilter" class="filter-select">
                                    <option value="">All Types</option>
                                    @foreach (var type in Model.Catalog.AvailableFrameTypes)
                                    {
                                        <option value="@type" selected="@(Model.FrameTypeFilter == type)">@type</option>
                                    }
                                </select>
                                <i class="bi bi-chevron-down select-arrow"></i>
                            </div>
                        }
                    </div>
                }

                @if (Model.ProductTypeFilter == "All" || Model.ProductTypeFilter == "Lens")
                {
                    <div class="filter-section lens-filters">
                        <h4><i class="bi bi-circle"></i> Lens Options</h4>
                        @if (Model.Catalog.AvailableLensTypes.Any())
                        {
                            <div class="select-wrapper">
                                <label for="lensTypeFilter">Lens Type</label>
                                <select name="LensTypeFilter" id="lensTypeFilter" class="filter-select">
                                    <option value="">All Lens Types</option>
                                    @foreach (var type in Model.Catalog.AvailableLensTypes)
                                    {
                                        <option value="@type" selected="@(Model.LensTypeFilter == type)">@type</option>
                                    }
                                </select>
                                <i class="bi bi-chevron-down select-arrow"></i>
                            </div>
                        }
                    </div>
                }

                <input type="hidden" name="SortBy" value="@Model.SortBy" />

                <div class="filter-actions">
                    <button type="submit" class="btn-apply-filters">
                        <i class="bi bi-check-lg"></i> Apply Filters
                    </button>
                </div>
            </form>
        </aside>

        <!-- Products Section -->
        <section class="products-section">
            <div class="results-header">
                <div class="results-count">
                    @if (Model.Catalog.TotalItems > 0)
                    {
                        <span>Showing <strong>@Model.Catalog.StartItem‚Äì@Model.Catalog.EndItem</strong> of <strong>@Model.Catalog.TotalItems</strong> products</span>
                    }
                    else
                    {
                        <span>No products found</span>
                    }
                </div>
                <div class="sort-wrapper">
                    <label for="sortSelect">Sort by:</label>
                    <div class="select-wrapper compact">
                        <select id="sortSelect" class="filter-select sort-select" onchange="updateSort(this.value)">
                            <option value="name" selected="@(Model.SortBy == "name")">Name (A-Z)</option>
                            <option value="price-low" selected="@(Model.SortBy == "price-low")">Price: Low to High</option>
                            <option value="price-high" selected="@(Model.SortBy == "price-high")">Price: High to Low</option>
                            <option value="newest" selected="@(Model.SortBy == "newest")">Newest First</option>
                        </select>
                        <i class="bi bi-chevron-down select-arrow"></i>
                    </div>
                </div>
            </div>

            <button class="mobile-filter-toggle" id="mobileFilterToggle">
                <i class="bi bi-funnel"></i> Filters
            </button>

            @if (Model.Catalog.Products.Any())
            {
                <div class="product-grid">
                    @foreach (var product in Model.Catalog.Products)
                    {
                        <article class="product-card" id="product-@product.ProductId">
                            <!-- Product Image -->
                            <div class="product-image">
                                @if (!string.IsNullOrEmpty(product.PrimaryImageUrl))
                                {
                                    <img src="@product.PrimaryImageUrl" alt="@product.Name" loading="lazy" />
                                }
                                else
                                {
                                    <div class="product-image-placeholder">
                                        <i class="bi bi-eyeglasses"></i>
                                    </div>
                                }

                                <!-- Product Type Badge -->
                                <span class="product-badge @product.ProductType.ToLower()">
                                    @product.ProductType
                                </span>

                                @* ‚îÄ‚îÄ Wishlist Button: CH·ªà hi·ªán khi h·∫øt h√†ng (InventoryQty == 0) ‚îÄ‚îÄ *@
                                @if (product.InventoryQty <= 0)
                                {
                                    <button class="btn-wishlist"
                                            data-product-id="@product.ProductId"
                                            data-in-wishlist="false"
                                            data-out-of-stock="true"
                                            onclick="toggleWishlist(this)"
                                            title="Save to Wishlist ‚Äî notify me when back in stock">
                                        <i class="bi bi-heart"></i>
                                    </button>
                                }
                            </div>

                            <!-- Product Info -->
                            <div class="product-info">
                                <h3 class="product-name">@product.Name</h3>

                                <p class="product-price">
                                    <span class="currency">@product.Currency</span>
                                    <span class="amount">@product.Price.ToString("N0")</span>
                                </p>

                                @if (!string.IsNullOrEmpty(product.Description))
                                {
                                    <p class="product-description">@product.Description</p>
                                }

                                <div class="product-attributes">
                                    @if (product.ProductType == "Frame")
                                    {
                                        @if (!string.IsNullOrEmpty(product.FrameMaterial))
                                        {
                                            <span class="attribute"><i class="bi bi-gem"></i> @product.FrameMaterial</span>
                                        }
                                        @if (!string.IsNullOrEmpty(product.FrameType))
                                        {
                                            <span class="attribute"><i class="bi bi-tag"></i> @product.FrameType</span>
                                        }
                                    }
                                    else if (product.ProductType == "Lens")
                                    {
                                        @if (!string.IsNullOrEmpty(product.LensType))
                                        {
                                            <span class="attribute"><i class="bi bi-circle"></i> @product.LensType</span>
                                        }
                                        @if (product.IsPrescription == true)
                                        {
                                            <span class="attribute prescription"><i class="bi bi-check-circle"></i> Prescription</span>
                                        }
                                    }
                                </div>

                                <!-- Action Buttons -->
                                <div class="product-actions">
                                    @if (product.InventoryQty <= 0)
                                    {
                                        @* H·∫øt h√†ng: ch·ªâ hi·ªán n√∫t Details, kh√¥ng c√≥ Add to Cart *@
                                        <span class="badge bg-secondary me-2" style="font-size:11px; padding: 6px 10px; align-self:center;">
                                            <i class="bi bi-x-circle me-1"></i>Out of Stock
                                        </span>
                                        @if (product.ProductType == "Frame")
                                        {
                                            <a asp-page="/Products/FrameDetails"
                                               asp-route-id="@product.ProductId"
                                               class="btn-view-details-outline" title="View Details">
                                                Details
                                            </a>
                                        }
                                        else
                                        {
                                            <a asp-page="/Products/LensDetails"
                                               asp-route-id="@product.ProductId"
                                               class="btn-view-details-outline" title="View Details">
                                                Details
                                            </a>
                                        }
                                    }
                                    else
                                    {
                                        @* C√≤n h√†ng: hi·ªán Add to Cart + Details + Buy Now nh∆∞ b√¨nh th∆∞·ªùng *@
                                        @if (product.ProductType == "Frame")
                                        {
                                            <button onclick="addToCart(this, @product.ProductId)" class="btn-add-cart" title="Add to Cart">
                                                <i class="bi bi-cart-plus"></i> Add
                                            </button>
                                            <a asp-page="/Products/FrameDetails"
                                               asp-route-id="@product.ProductId"
                                               class="btn-view-details-outline" title="View Details">
                                                Details
                                            </a>
                                        }
                                        else
                                        {
                                            <button onclick="addToCart(this, @product.ProductId)" class="btn-add-cart" title="Add to Cart">
                                                <i class="bi bi-cart-plus"></i> Add
                                            </button>
                                            <a asp-page="/Products/LensDetails"
                                               asp-route-id="@product.ProductId"
                                               class="btn-view-details-outline" title="View Details">
                                                Details
                                            </a>
                                        }
                                        <button onclick="addToCart(this, @product.ProductId, true)" class="btn-buy-now">
                                            Buy Now
                                        </button>
                                    }
                                </div>
                            </div>
                        </article>
                    }
                </div>

                <!-- Pagination -->
                @if (Model.Catalog.TotalPages > 1)
                {
                    <nav class="pagination-nav" aria-label="Product pagination">
                        <ul class="pagination">
                            <li class="page-item @(!Model.Catalog.HasPreviousPage ? "disabled" : "")">
                                @if (Model.Catalog.HasPreviousPage)
                                {
                                    <a class="page-link prev"
                                       asp-page="/Products/Index"
                                       asp-route-ProductTypeFilter="@Model.ProductTypeFilter"
                                       asp-route-SearchTerm="@Model.SearchTerm"
                                       asp-route-MinPrice="@Model.MinPrice"
                                       asp-route-MaxPrice="@Model.MaxPrice"
                                       asp-route-FrameMaterialFilter="@Model.FrameMaterialFilter"
                                       asp-route-FrameTypeFilter="@Model.FrameTypeFilter"
                                       asp-route-LensTypeFilter="@Model.LensTypeFilter"
                                       asp-route-SortBy="@Model.SortBy"
                                       asp-route-CurrentPage="@(Model.CurrentPage - 1)"
                                       aria-label="Previous page">
                                        <i class="bi bi-chevron-left"></i>
                                    </a>
                                }
                                else
                                {
                                    <span class="page-link prev disabled"><i class="bi bi-chevron-left"></i></span>
                                }
                            </li>

                            @{
                                int startPage = Math.Max(1, Model.CurrentPage - 2);
                                int endPage = Math.Min(Model.Catalog.TotalPages, Model.CurrentPage + 2);
                                if (endPage - startPage < 4)
                                {
                                    if (startPage == 1) endPage = Math.Min(5, Model.Catalog.TotalPages);
                                    else if (endPage == Model.Catalog.TotalPages) startPage = Math.Max(1, Model.Catalog.TotalPages - 4);
                                }
                            }

                            @if (startPage > 1)
                            {
                                <li class="page-item">
                                    <a class="page-link" asp-page="/Products/Index"
                                       asp-route-ProductTypeFilter="@Model.ProductTypeFilter"
                                       asp-route-SearchTerm="@Model.SearchTerm"
                                       asp-route-MinPrice="@Model.MinPrice"
                                       asp-route-MaxPrice="@Model.MaxPrice"
                                       asp-route-FrameMaterialFilter="@Model.FrameMaterialFilter"
                                       asp-route-FrameTypeFilter="@Model.FrameTypeFilter"
                                       asp-route-LensTypeFilter="@Model.LensTypeFilter"
                                       asp-route-SortBy="@Model.SortBy"
                                       asp-route-CurrentPage="1">1</a>
                                </li>
                                @if (startPage > 2)
                                {
                                    <li class="page-item ellipsis"><span class="page-link">...</span></li>
                                }
                            }

                            @for (int i = startPage; i <= endPage; i++)
                            {
                                <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                                    @if (i == Model.CurrentPage)
                                    {
                                        <span class="page-link" aria-current="page">@i</span>
                                    }
                                    else
                                    {
                                        <a class="page-link" asp-page="/Products/Index"
                                           asp-route-ProductTypeFilter="@Model.ProductTypeFilter"
                                           asp-route-SearchTerm="@Model.SearchTerm"
                                           asp-route-MinPrice="@Model.MinPrice"
                                           asp-route-MaxPrice="@Model.MaxPrice"
                                           asp-route-FrameMaterialFilter="@Model.FrameMaterialFilter"
                                           asp-route-FrameTypeFilter="@Model.FrameTypeFilter"
                                           asp-route-LensTypeFilter="@Model.LensTypeFilter"
                                           asp-route-SortBy="@Model.SortBy"
                                           asp-route-CurrentPage="@i">@i</a>
                                    }
                                </li>
                            }

                            @if (endPage < Model.Catalog.TotalPages)
                            {
                                @if (endPage < Model.Catalog.TotalPages - 1)
                                {
                                    <li class="page-item ellipsis"><span class="page-link">...</span></li>
                                }
                                <li class="page-item">
                                    <a class="page-link" asp-page="/Products/Index"
                                       asp-route-ProductTypeFilter="@Model.ProductTypeFilter"
                                       asp-route-SearchTerm="@Model.SearchTerm"
                                       asp-route-MinPrice="@Model.MinPrice"
                                       asp-route-MaxPrice="@Model.MaxPrice"
                                       asp-route-FrameMaterialFilter="@Model.FrameMaterialFilter"
                                       asp-route-FrameTypeFilter="@Model.FrameTypeFilter"
                                       asp-route-LensTypeFilter="@Model.LensTypeFilter"
                                       asp-route-SortBy="@Model.SortBy"
                                       asp-route-CurrentPage="@Model.Catalog.TotalPages">@Model.Catalog.TotalPages</a>
                                </li>
                            }

                            <li class="page-item @(!Model.Catalog.HasNextPage ? "disabled" : "")">
                                @if (Model.Catalog.HasNextPage)
                                {
                                    <a class="page-link next"
                                       asp-page="/Products/Index"
                                       asp-route-ProductTypeFilter="@Model.ProductTypeFilter"
                                       asp-route-SearchTerm="@Model.SearchTerm"
                                       asp-route-MinPrice="@Model.MinPrice"
                                       asp-route-MaxPrice="@Model.MaxPrice"
                                       asp-route-FrameMaterialFilter="@Model.FrameMaterialFilter"
                                       asp-route-FrameTypeFilter="@Model.FrameTypeFilter"
                                       asp-route-LensTypeFilter="@Model.LensTypeFilter"
                                       asp-route-SortBy="@Model.SortBy"
                                       asp-route-CurrentPage="@(Model.CurrentPage + 1)"
                                       aria-label="Next page">
                                        <i class="bi bi-chevron-right"></i>
                                    </a>
                                }
                                else
                                {
                                    <span class="page-link next disabled"><i class="bi bi-chevron-right"></i></span>
                                }
                            </li>
                        </ul>
                    </nav>
                }
            }
            else
            {
                <div class="empty-state">
                    <div class="empty-state-icon"><i class="bi bi-eyeglasses"></i></div>
                    <h2>No Products Found</h2>
                    <p>We couldn't find any products matching your criteria.</p>
                    <p class="empty-state-hint">Try adjusting your filters or search terms.</p>
                    <a asp-page="/Products/Index" class="btn-clear-filters">
                        <i class="bi bi-arrow-counterclockwise"></i> Clear All Filters
                    </a>
                </div>
            }
        </section>
    </div>
</div>

@section Scripts {
    <script>
        function updateSort(value) {
            const url = new URL(window.location.href);
            url.searchParams.set('SortBy', value);
            url.searchParams.set('CurrentPage', '1');
            window.location.href = url.toString();
        }

        document.addEventListener('DOMContentLoaded', function() {
            const mobileToggle = document.getElementById('mobileFilterToggle');
            const filterSidebar = document.getElementById('filterSidebar');
            if (mobileToggle && filterSidebar) {
                mobileToggle.addEventListener('click', function() {
                    filterSidebar.classList.toggle('show');
                    mobileToggle.classList.toggle('active');
                });
            }
            document.addEventListener('click', function(e) {
                if (window.innerWidth < 992 &&
                    filterSidebar?.classList.contains('show') &&
                    !filterSidebar.contains(e.target) &&
                    !mobileToggle.contains(e.target)) {
                    filterSidebar.classList.remove('show');
                    mobileToggle.classList.remove('active');
                }
            });
        });
    </script>
    <script src="~/js/shop-cart.js" asp-append-version="true"></script>

    @* ‚îÄ‚îÄ Wishlist Script ‚îÄ‚îÄ *@
    <script>
        // Toast helper
        let _wlToast = null;
        function showWlToast(msg, icon = '‚ô°') {
            if (!_wlToast) {
                _wlToast = document.createElement('div');
                _wlToast.id = 'wl-toast';
                document.body.appendChild(_wlToast);
            }
            _wlToast.innerHTML = `<span class="wl-icon">${icon}</span>${msg}`;
            _wlToast.classList.add('show');
            clearTimeout(_wlToast._t);
            _wlToast._t = setTimeout(() => _wlToast.classList.remove('show'), 2800);
        }

        async function toggleWishlist(btn) {
            @if (!User.Identity.IsAuthenticated)
            {
                    <text>
                    showWlToast('Please login to save items', 'üîí');
                    setTimeout(() => window.location.href = '/Account/Login', 1200);
                    return;
                    </text>
            }

            const productId    = parseInt(btn.dataset.productId);
            const isInWishlist = btn.dataset.inWishlist === 'true';
            btn.disabled = true;

            try {
                if (isInWishlist) {
                    const res = await fetch('/api/wishlist/remove', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ productId })
                    });
                    if (res.ok) {
                        btn.dataset.inWishlist = 'false';
                        btn.querySelector('i').className = 'bi bi-heart';
                        btn.classList.remove('active');
                        showWlToast('Removed from wishlist', 'ü§ç');
                    }
                } else {
                    const res  = await fetch('/api/wishlist/add', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ productId })
                    });
                    const data = await res.json();
                    if (res.ok) {
                        btn.dataset.inWishlist = 'true';
                        btn.querySelector('i').className = 'bi bi-heart-fill';
                        btn.classList.add('active');
                        // Pop animation
                        btn.classList.add('pop');
                        btn.addEventListener('animationend', () => btn.classList.remove('pop'), { once: true });
                        showWlToast("Saved! We'll notify you when it's back ‚ù§Ô∏è", '‚ô°');
                    } else {
                        showWlToast(data.message || 'Something went wrong', '‚ö†Ô∏è');
                    }
                }
            } catch {
                showWlToast('Network error. Try again.', '‚ö†Ô∏è');
            } finally {
                btn.disabled = false;
            }
        }

        // Highlight already-wishlisted items on load
        document.addEventListener('DOMContentLoaded', async () => {
            @if (User.Identity.IsAuthenticated)
            {
                    <text>
                    try {
                        const res = await fetch('/api/wishlist/my');
                        if (!res.ok) return;
                        const items = await res.json();
                        const ids = new Set(items.map(i => i.productId));
                        document.querySelectorAll('.btn-wishlist').forEach(btn => {
                            if (ids.has(parseInt(btn.dataset.productId))) {
                                btn.dataset.inWishlist = 'true';
                                btn.querySelector('i').className = 'bi bi-heart-fill';
                                btn.classList.add('active');
                            }
                        });
                    } catch {}
                    </text>
            }
        });
    </script>
}

<!-- Anti-forgery token for AJAX -->
@Html.AntiForgeryToken()
