@page
@model EyewearStore_SWP391.Pages.Profile.IndexModel
@{
    ViewData["Title"] = "My Profile";
}

<div class="container py-5">

    <div class="mb-4">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a asp-page="/Index">Home</a></li>
                <li class="breadcrumb-item active" aria-current="page">My Profile</li>
            </ol>
        </nav>
        <h1 style="font-family: var(--font-secondary);
                   color: var(--primary-navy);
                   font-size: 2.5rem;
                   margin-bottom: 0.5rem;">
            👤 My Profile
        </h1>
        <p style="color: var(--secondary-warm-gray); font-size: 1.1rem;">
            Manage your account settings and preferences
        </p>
    </div>

    <!-- Alert Messages -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert" style="border-radius: 8px; border-left: 4px solid var(--success);">
            <strong>✓</strong> @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert" style="border-radius: 8px; border-left: 4px solid var(--error);">
            <strong>⚠</strong> @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="row g-4">
        <!-- Left Column - Personal Info & Password -->
        <div class="col-lg-5">
            <!-- Personal Information Card -->
            <div class="card mb-4" style="border: none; border-radius: 12px; box-shadow: var(--shadow-md);">
                <div style="background: linear-gradient(135deg, var(--primary-navy) 0%, var(--primary-navy-light) 100%);
                            padding: 1.5rem;
                            border-radius: 12px 12px 0 0;">
                    <h5 style="color: white; margin: 0; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                        <span>📋</span>
                        Personal Information
                    </h5>
                </div>

                <div style="padding: 2rem;">
                    <form method="post" asp-page-handler="UpdateProfile">
                        <div class="mb-3">
                            <label class="form-label" style="font-weight: 600; color: var(--primary-navy); font-size: 0.9rem;">
                                📧 Email Address
                            </label>
                            <input class="form-control"
                                   value="@Model.Input?.Email"
                                   disabled
                                   style="background-color: var(--light-gray);
                                          border: 2px solid var(--medium-gray);
                                          border-radius: 8px;
                                          padding: 0.875rem 1rem;" />
                            <small class="text-muted" style="font-size: 0.85rem; display: block; margin-top: 0.25rem;">
                                Email cannot be changed
                            </small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label" style="font-weight: 600; color: var(--primary-navy); font-size: 0.9rem;">
                                👤 Full Name
                            </label>
                            <input asp-for="Input.FullName"
                                   class="form-control"
                                   placeholder="Enter your full name"
                                   style="border: 2px solid var(--medium-gray);
                                          border-radius: 8px;
                                          padding: 0.875rem 1rem;" />
                            <span asp-validation-for="Input.FullName" class="text-danger"></span>
                        </div>

                        <div class="mb-4">
                            <label class="form-label" style="font-weight: 600; color: var(--primary-navy); font-size: 0.9rem;">
                                📱 Phone Number
                            </label>
                            <input asp-for="Input.Phone"
                                   class="form-control"
                                   placeholder="+84 123 456 789"
                                   style="border: 2px solid var(--medium-gray);
                                          border-radius: 8px;
                                          padding: 0.875rem 1rem;" />
                            <span asp-validation-for="Input.Phone" class="text-danger"></span>
                        </div>

                        <button class="btn btn-primary w-100"
                                type="submit"
                                style="padding: 1rem;
                                       background: linear-gradient(135deg, var(--primary-navy) 0%, var(--primary-navy-light) 100%);
                                       border: none;
                                       border-radius: 8px;
                                       font-weight: 600;
                                       text-transform: uppercase;
                                       letter-spacing: 0.5px;">
                            💾 Save Changes
                        </button>
                    </form>
                </div>
            </div>

            <!-- Change Password Card -->
            <div class="card" style="border: none; border-radius: 12px; box-shadow: var(--shadow-md);">
                <div style="background: linear-gradient(135deg, var(--primary-gold) 0%, var(--primary-gold-light) 100%);
                            padding: 1.5rem;
                            border-radius: 12px 12px 0 0;">
                    <h5 style="color: white; margin: 0; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                        <span>🔐</span>
                        Change Password
                    </h5>
                </div>

                <div style="padding: 2rem;">
                    <form method="post" asp-page-handler="ChangePassword">
                        <div class="mb-3">
                            <label class="form-label" style="font-weight: 600; color: var(--primary-navy); font-size: 0.9rem;">
                                Current Password
                            </label>
                            <input asp-for="ChangePassword.CurrentPassword"
                                   type="password"
                                   class="form-control"
                                   placeholder="Enter current password"
                                   style="border: 2px solid var(--medium-gray);
                                          border-radius: 8px;
                                          padding: 0.875rem 1rem;" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label" style="font-weight: 600; color: var(--primary-navy); font-size: 0.9rem;">
                                New Password
                            </label>
                            <input asp-for="ChangePassword.NewPassword"
                                   type="password"
                                   class="form-control"
                                   placeholder="Enter new password"
                                   style="border: 2px solid var(--medium-gray);
                                          border-radius: 8px;
                                          padding: 0.875rem 1rem;" />
                            <small class="text-muted" style="font-size: 0.85rem; display: block; margin-top: 0.25rem;">
                                Minimum 6 characters
                            </small>
                        </div>

                        <div class="mb-4">
                            <label class="form-label" style="font-weight: 600; color: var(--primary-navy); font-size: 0.9rem;">
                                Confirm New Password
                            </label>
                            <input asp-for="ChangePassword.ConfirmPassword"
                                   type="password"
                                   class="form-control"
                                   placeholder="Re-enter new password"
                                   style="border: 2px solid var(--medium-gray);
                                          border-radius: 8px;
                                          padding: 0.875rem 1rem;" />
                        </div>

                        <button class="btn w-100"
                                type="submit"
                                style="padding: 1rem;
                                       background: linear-gradient(135deg, var(--primary-gold) 0%, var(--primary-gold-light) 100%);
                                       color: white;
                                       border: none;
                                       border-radius: 8px;
                                       font-weight: 600;
                                       text-transform: uppercase;
                                       letter-spacing: 0.5px;">
                            🔄 Update Password
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Right Column - Shipping Addresses -->
        <div class="col-lg-7">
            <div class="card" style="border: none; border-radius: 12px; box-shadow: var(--shadow-md);">
                <!-- Header -->
                <div style="background: linear-gradient(135deg, var(--secondary-teal) 0%, #4a7c7e 100%);
                            padding: 1.5rem;
                            border-radius: 12px 12px 0 0;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            flex-wrap: wrap;
                            gap: 1rem;">
                    <h5 style="color: white; margin: 0; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                        <span>📍</span>
                        Shipping Addresses
                    </h5>
                    <button class="btn btn-sm"
                            data-bs-toggle="modal"
                            data-bs-target="#addressModal"
                            onclick="openAddAddressModal()"
                            style="background: white;
                                   color: var(--secondary-teal);
                                   border: none;
                                   padding: 0.5rem 1.5rem;
                                   border-radius: 6px;
                                   font-weight: 600;">
                        ➕ Add Address
                    </button>
                </div>

                <!-- Addresses List -->
                <div style="padding: 2rem;">
                    @if (Model.Addresses == null || !Model.Addresses.Any())
                    {
                        <!-- Empty State -->
                        <div style="text-align: center; padding: 3rem 2rem;">
                            <div style="font-size: 4rem; opacity: 0.2; margin-bottom: 1rem;">📍</div>
                            <h5 style="color: var(--primary-navy); margin-bottom: 0.5rem;">
                                No Addresses Yet
                            </h5>
                            <p style="color: var(--secondary-warm-gray); margin-bottom: 1.5rem;">
                                Add your first shipping address to make checkout faster
                            </p>
                            <button class="btn btn-primary"
                                    data-bs-toggle="modal"
                                    data-bs-target="#addressModal"
                                    onclick="openAddAddressModal()"
                                    style="background: linear-gradient(135deg, var(--primary-navy) 0%, var(--primary-navy-light) 100%);
                                                       border: none;
                                                       padding: 0.75rem 2rem;
                                                       border-radius: 8px;">
                                ➕ Add Your First Address
                            </button>
                        </div>
                    }
                    else
                    {
                        <div class="list-group" style="gap: 1rem;">
                            @foreach (var a in Model.Addresses)
                            {
                                <div style="padding: 1.5rem;
                                                                    border: 2px solid @(a.IsDefault ? "var(--primary-gold)" : "var(--medium-gray)");
                                                                    border-radius: 12px;
                                                                    background: @(a.IsDefault ? "rgba(212, 165, 116, 0.05)" : "white");
                                                                    transition: all 0.3s ease;"
                                     onmouseover="this.style.boxShadow='var(--shadow-md)'; this.style.borderColor='var(--primary-gold)';"
                                     onmouseout="this.style.boxShadow='none'; this.style.borderColor='@(a.IsDefault ? "var(--primary-gold)" : "var(--medium-gray)")';">

                                    <div class="d-flex justify-content-between align-items-start gap-3">
                                        <div class="flex-grow-1">
                                            <!-- Receiver Info -->
                                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.75rem; flex-wrap: wrap;">
                                                <strong style="color: var(--primary-navy); font-size: 1.1rem;">
                                                    @a.ReceiverName
                                                </strong>
                                                <span style="color: var(--secondary-warm-gray); font-size: 0.95rem;">
                                                    | 📱 @a.Phone
                                                </span>
                                            </div>

                                            <!-- Address Line -->
                                            <div style="color: var(--dark-gray);
                                                                                margin-bottom: 1rem;
                                                                                line-height: 1.6;
                                                                                padding-left: 1.5rem;
                                                                                border-left: 3px solid var(--light-gray);">
                                                📍 @a.AddressLine
                                            </div>

                                            <!-- Default Badge & Set Default Button -->
                                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                                @if (a.IsDefault)
                                                {
                                                    <span style="background: linear-gradient(135deg, var(--primary-gold) 0%, var(--primary-gold-light) 100%);
                                                                                                     color: white;
                                                                                                     padding: 0.35rem 1rem;
                                                                                                     border-radius: 20px;
                                                                                                     font-size: 0.85rem;
                                                                                                     font-weight: 600;">
                                                        ⭐ Default Address
                                                    </span>
                                                }
                                                else
                                                {
                                                    <form method="post" asp-page-handler="SetDefault" style="display:inline; margin: 0;">
                                                        <input type="hidden" name="addressId" value="@a.AddressId" />
                                                        <button type="submit"
                                                                style="background: transparent;
                                                                                                           border: 2px solid var(--primary-gold);
                                                                                                           color: var(--primary-gold);
                                                                                                           padding: 0.35rem 1rem;
                                                                                                           border-radius: 20px;
                                                                                                           font-size: 0.85rem;
                                                                                                           font-weight: 600;
                                                                                                           cursor: pointer;
                                                                                                           transition: all 0.3s ease;">
                                                            Set as Default
                                                        </button>
                                                    </form>
                                                }
                                            </div>
                                        </div>

                                        <!-- Action Buttons -->
                                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                            <button class="btn btn-sm"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#addressModal"
                                                    onclick="openEditAddressModal(@a.AddressId, '@(a.ReceiverName.Replace("'", "\\'"))', '@(a.Phone.Replace("'", "\\'"))', '@(a.AddressLine.Replace("'", "\\'"))', @(a.IsDefault.ToString().ToLower()))"
                                                    style="background: var(--light-gray);
                                                                                   color: var(--primary-navy);
                                                                                   border: none;
                                                                                   padding: 0.5rem 1rem;
                                                                                   border-radius: 6px;
                                                                                   font-weight: 500;
                                                                                   white-space: nowrap;">
                                                ✏️ Edit
                                            </button>

                                            <form method="post"
                                                  asp-page-handler="DeleteAddress"
                                                  style="display:inline; margin: 0;"
                                                  onsubmit="return confirm('Are you sure you want to delete this address?');">
                                                <input type="hidden" name="addressId" value="@a.AddressId" />
                                                <button type="submit"
                                                        style="background: transparent;
                                                                                       border: 2px solid var(--error);
                                                                                       color: var(--error);
                                                                                       padding: 0.5rem 1rem;
                                                                                       border-radius: 6px;
                                                                                       font-weight: 500;
                                                                                       cursor: pointer;
                                                                                       width: 100%;">
                                                    🗑️ Delete
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Address Modal -->
<div class="modal fade" id="addressModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content" style="border: none; border-radius: 16px; overflow: hidden;">
            <form method="post" id="addressForm">
                <!-- Modal Header -->
                <div style="background: linear-gradient(135deg, var(--secondary-teal) 0%, #4a7c7e 100%);
                            padding: 1.5rem 2rem;">
                    <h5 style="color: white; margin: 0; font-weight: 600;" id="addressModalTitle">
                        Add New Address
                    </h5>
                </div>

                <!-- Modal Body -->
                <div style="padding: 2rem;">
                    <input type="hidden" asp-for="AddressInput.AddressId" id="AddressId" />

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label" style="font-weight: 600; color: var(--primary-navy); font-size: 0.9rem;">
                                👤 Receiver Name
                            </label>
                            <input asp-for="AddressInput.ReceiverName"
                                   class="form-control"
                                   id="ReceiverName"
                                   placeholder="Full name"
                                   style="border: 2px solid var(--medium-gray);
                                          border-radius: 8px;
                                          padding: 0.875rem 1rem;" />
                        </div>

                        <div class="col-md-6">
                            <label class="form-label" style="font-weight: 600; color: var(--primary-navy); font-size: 0.9rem;">
                                📱 Phone Number
                            </label>
                            <input asp-for="AddressInput.Phone"
                                   class="form-control"
                                   id="Phone"
                                   placeholder="+84 123 456 789"
                                   style="border: 2px solid var(--medium-gray);
                                          border-radius: 8px;
                                          padding: 0.875rem 1rem;" />
                        </div>

                        <div class="col-12">
                            <label class="form-label" style="font-weight: 600; color: var(--primary-navy); font-size: 0.9rem;">
                                📍 Full Address
                            </label>
                            <input asp-for="AddressInput.AddressLine"
                                   class="form-control"
                                   id="AddressLine"
                                   placeholder="Street, Ward, District, City, Province"
                                   style="border: 2px solid var(--medium-gray);
                                          border-radius: 8px;
                                          padding: 0.875rem 1rem;" />
                        </div>

                        <div class="col-12">
                            <div class="form-check" style="padding-left: 0;">
                                <input asp-for="AddressInput.IsDefault"
                                       class="form-check-input"
                                       id="IsDefault"
                                       style="width: 1.25rem; height: 1.25rem; margin-right: 0.5rem; cursor: pointer;" />
                                <label class="form-check-label" style="cursor: pointer; user-select: none;">
                                    ⭐ Set as default shipping address
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal Footer -->
                <div style="padding: 1rem 2rem;
                            background: var(--light-gray);
                            display: flex;
                            justify-content: flex-end;
                            gap: 0.75rem;">
                    <button type="button"
                            class="btn"
                            data-bs-dismiss="modal"
                            style="background: transparent;
                                   border: 2px solid var(--medium-gray);
                                   color: var(--dark-gray);
                                   padding: 0.75rem 1.5rem;
                                   border-radius: 8px;
                                   font-weight: 600;">
                        Cancel
                    </button>
                    <button type="submit"
                            id="addressSaveButton"
                            class="btn"
                            style="background: linear-gradient(135deg, var(--secondary-teal) 0%, #4a7c7e 100%);
                                   color: white;
                                   border: none;
                                   padding: 0.75rem 2rem;
                                   border-radius: 8px;
                                   font-weight: 600;">
                        💾 Save Address
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function openAddAddressModal() {
            document.getElementById('addressModalTitle').innerText = '➕ Add New Address';
            document.getElementById('ReceiverName').value = '';
            document.getElementById('Phone').value = '';
            document.getElementById('AddressLine').value = '';
            document.getElementById('IsDefault').checked = false;
            document.getElementById('AddressId').value = '';
            document.getElementById('addressForm').action = '?handler=AddAddress';
        }

        function openEditAddressModal(id, receiver, phone, addressLine, isDefault) {
            document.getElementById('addressModalTitle').innerText = '✏️ Edit Address';
            document.getElementById('ReceiverName').value = receiver || '';
            document.getElementById('Phone').value = phone || '';
            document.getElementById('AddressLine').value = addressLine || '';
            document.getElementById('IsDefault').checked = (isDefault === 'true' || isDefault === true);
            document.getElementById('AddressId').value = id || '';
            document.getElementById('addressForm').action = '?handler=EditAddress';
        }
    </script>
}
